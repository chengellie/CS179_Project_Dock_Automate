{% extends "base.html" %}
{% block title %} Table {% endblock %}
{% block content %}
<style>
    table,
    th,
    td {
        border: 5px solid black;
        padding: 1px;
    }

    table {
        border-spacing: 3px;
    }
</style>

<div class="w3-row-padding">
    <div class="w3-half w3-container">
        <h5> </h5>
    </div>
    <div class="w3-half w3-container">
        <table style="width:100%">
            {%for i in range(row)%}
            <tr>
                {% for j in range(col)%}
                    {% if "UNUSED" == item[i][j].name%}
                        <td id="ship_{{i}}_{{j}}" style="background-color:white;color:white;">{{item[i][j]}}</td>
                    {% elif "NAN" == item[i][j].name%}
                        <td id="ship_{{i}}_{{j}}" style="background-color:grey;color:grey;">{{item[i][j]}}</td>
                    {% else %}
                        <td id="ship_{{i}}_{{j}}" style="background-color:{{color[0]}};color:white;">{{item[i][j]}}</td>
                    {% endif%}
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
</div>



<script>

    // https://stackoverflow.com/questions/3583724/how-do-i-add-a-delay-in-a-javascript-loop
    const timer = ms => new Promise(res => setTimeout(res, ms))
    var moves_list = {{ moves|tojson }};
    var space_flag = true;
    var loop_flag = "loop";

    async function swap() { // We need to wrap the loop into an async function for this to work
        // var moves = {{ moves|tojson }};
        var moves = moves_list.shift();
        var id_start;
        var id_end;
        while(true){
            for (var i = 0; i + 1 < moves.length; i++) {
                console.log(i);
                id_start = moves[i];
                id_end = moves[i+1];
                var text_start = $(id_start).text();
                var text_end = $(id_end).text();
                var color_start = $(id_start).css( "color" );
                var color_end = $(id_end).css( "color" );
                $(id_end).text(text_start);
                $(id_end).css('background-color', 'red');
                $(id_end).css('color', color_start);
                $(id_start).text(text_end);
                $(id_start).css('background-color', color_end);
                $(id_start).css('color', color_end);

                await timer(500); // then the created Promise can be awaited
            }
            $(id_end).css('background-color', '{{color[0]}}');

            if(loop_flag == "stop_loop"){
                break;
            }

            if(loop_flag == "loop" || loop_flag == "keep_loop"){
                id_start = moves[moves.length-1];
                id_end = moves[0];
                
                var text_start = $(id_start).text();
                var text_end = $(id_end).text();
                var color_start = $(id_start).css( "color" );
                var color_end = $(id_end).css( "color" );
                $(id_end).text(text_start);
                $(id_end).css('background-color', 'red');
                $(id_end).css('color', color_start);
                $(id_start).text(text_end);
                $(id_start).css('background-color', color_end);
                $(id_start).css('color', color_end);
                loop_flag = "keep_loop";
                await timer(500); // then the created Promise can be awaited
            }
        }
        loop_flag = "loop";
        swap();

    }

    // console.log({{moves[0]}})
    // $("{{moves[0]}}").click(function () { 
    //     swap();
    // });  
    document.body.onkeydown = function(e){
        if(e.keyCode == 32 && space_flag){
            space_flag = false; 
            swap();
        }
        if(e.keyCode == 32 && loop_flag == "keep_loop"){
            loop_flag = "stop_loop";
        }
    }
    
    


</script>
{% endblock %}